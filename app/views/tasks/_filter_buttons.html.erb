<% base_params = params.permit(:search, :page, :sort, :filter, :status, :priority).to_h %>

  <div id="filter-modal" class="modal">
    <div class="modal-content">
      <h3>Filter</h3>
      </div>
      <div>
        <%= form_with url: tasks_path, method: :get, local: true do %>
          <div data-controller="filter">
            <%= check_box_tag 'filter[mode]', 'all', params.dig(:filter, :mode) == 'all', id: 'filter_mode_all',
            data: { filter_target: "allMode", action: "change->filter#toggle" } %>
            <fieldset data-filter-target="fieldset" <%= 'disabled' if @all_mode %> aria-disabled="<%= @all_mode %>">
              <div class="filter-buttons">
                <%= radio_button_tag 'filter[period]', 'today', params.dig(:filter, :period) == 'today', id: 'filter_today', class: 'hidden-checkbox', disabled: @all_mode %>
                <%= label_tag 'filter_today', '今日', class: 'toggle-btn btn' %>
                <%= radio_button_tag 'filter[period]', 'this_week', params.dig(:filter, :period) == 'this_week', id: 'filter_this_week', class: 'hidden-checkbox', disabled: @all_mode %>
                <%= label_tag 'filter_this_week', '今週', class: 'toggle-btn btn' %>
                <%= radio_button_tag 'filter[period]', 'overdue', params.dig(:filter, :period) == 'overdue', id: 'filter_overdue', class: 'hidden-checkbox', disabled: @all_mode %>
                <%= label_tag 'filter_overdue', '期限切れ', class: 'toggle-btn btn' %>
              </div>
              <div class="filter-buttons">
                <%= radio_button_tag 'filter[priority]', 'high', params.dig(:filter, :priority) == 'high', id: 'priority_high', class: 'hidden-checkbox', disabled: @all_mode %>
                <%= label_tag 'priority_high', '高', class: 'toggle-btn btn' %>
                <%= radio_button_tag 'filter[priority]', 'medium', params.dig(:filter, :priority) == 'medium', id: 'priority_medium', class: 'hidden-checkbox', disabled: @all_mode %>
                <%= label_tag 'priority_medium', '中', class: 'toggle-btn btn' %>
                <%= radio_button_tag 'filter[priority]', 'low', params.dig(:filter, :priority) == 'low', id: 'priority_low', class: 'hidden-checkbox', disabled: @all_mode %>
                <%= label_tag 'priority_low', '低', class: 'toggle-btn btn' %>
              </div>
              <div class="filter-buttons">
                <%= check_box_tag 'filter[status][]', 'not_started', Array(params.dig(:filter, :status)).include?('not_started'), id: 'status_not_started', class: 'hidden-checkbox', disabled: @all_mode %>
                <%= label_tag 'status_not_started', '未着手', class: "toggle-btn btn btn-secondary" %>
                <%= check_box_tag 'filter[status][]', 'in_progress', Array(params.dig(:filter, :status)).include?('in_progress'), id: 'status_in_progress', class: 'hidden-checkbox', disabled: @all_mode %>
                <%= label_tag 'status_in_progress', '進行中', class: "toggle-btn btn btn-warning" %>
                <%= check_box_tag 'filter[status][]', 'completed', Array(params.dig(:filter, :status)).include?('completed'), id: 'status_completed', class: 'hidden-checkbox', disabled: @all_mode %>
                <%= label_tag 'status_completed', '完了', class: "toggle-btn btn btn-success" %>
              </div>
            </fieldset>
            <div class="filter-buttons">
              <%= radio_button_tag 'filter[sort]', 'created_at', params.dig(:filter, :sort) == 'created_at', id: 'sort_created_at', class: 'hidden-checkbox' %>
              <%= label_tag 'sort_created_at', '作成順', class: 'toggle-btn btn' %>
              <%= radio_button_tag 'filter[sort]', 'deadline', params.dig(:filter, :sort) == 'deadline', id: 'sort_deadline', class: 'hidden-checkbox' %>
              <%= label_tag 'sort_deadline', '期限順', class: 'toggle-btn btn' %>
              <%= radio_button_tag 'filter[sort]', 'priority', params.dig(:filter, :sort) == 'priority', id: 'sort_priority', class: 'hidden-checkbox' %>
              <%= label_tag 'sort_priority', '優先度順', class: 'toggle-btn btn' %>
            </div>
          </div>
        </div>
        <div class="actions">
          <%= button_tag 'クリア', type: 'reset', class: 'clear-btn btn btn-secondary' %>
          <%= submit_tag '適用', class: 'apply-btn btn btn-primary' %>
        </div>
      <% end %>
      <script>
        (function() {
          function attachFilterFallback() {
            const cb = document.getElementById('filter_mode_all');
            const fieldset = document.querySelector('[data-filter-target="fieldset"]');
            if (!cb) return;
            const handler = () => { if (fieldset) fieldset.disabled = !!cb.checked; };
            try { cb.removeEventListener('change', handler); } catch (e) {}
            cb.addEventListener('change', handler);
            handler();
          }
          attachFilterFallback();
          setTimeout(attachFilterFallback, 50);
        })();
      </script>
      </div>
    </div>
  </div>