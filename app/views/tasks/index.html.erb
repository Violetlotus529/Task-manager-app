<div class="index-container">
  <h1>タスク一覧</h1>

  <%= link_to "Filter", filter_modal_tasks_path, class: "btn btn-outline" %>

  <div class="search-container">
    <%= form_with url: tasks_path, method: :get, local: :true, class: "search-form" do |form| %>
      <%= form.text_field :search,
          placeholder: "タスクを検索...",
          value: params[:search],
          class: "search-input" %>
      <%= form.submit "検索", class: "btn btn-search" %>
      <% if params[:search].present? %>
        <%= link_to "クリア", tasks_path, class: "btn btn-clear" %>
      <% end %>
    <% end %>

    <% if params[:search].present? %>
      <p class="search-results">
        「<%= params[:search] %>」の検索結果: <%= @tasks.count %>件
      </p>
    <% end %>
  </div>

  <div class="actions-bar">
    <%= link_to "新しいタスクを作成", "/tasks/new", class: "btn btn-primary" %>
  </div>

  <% if @tasks.any? %>
    <% group_key = params[:group_by] || (params[:sort] || params.dig(:filter, :sort)) %>
    <% if @tasks_by_group.present? %>
      <% @tasks_by_group.each do |group_value, tasks| %>
        <div class="task-group">
          <h2>
            <% if group_key == 'priority' %>
              優先度: <%= group_value || '未設定' %>
            <% elsif group_key == 'status' %>
              ステータス: <%= group_value || '未設定' %>
            <% elsif group_key == 'created_at' %>
              作成日: <%= group_value.present? ? l(group_value, format: :long) : '未設定' %>
            <% else %>
              <%= group_value.present? ? l(group_value, format: :long) : '期限未設定' %>
            <% end %>
          </h2>
          <ul class="task-list">
            <% tasks.each do |task| %>
              <li class="task-item">
                <%= link_to task.title, task_path(task), class: "task-title" %>
                <div class="task-meta">
                  <span class="task-deadline"><%= task.deadline&.to_date %></span>
                  <span class="task-status"><%= task.status %></span>
                  <span class="task-priority"><%= task.priority %></span>
                </div>

                <div class="task-actions">
                  <%= link_to "表示", task_path(task), 
                      class: "btn btn-outline btn-sm", 
                      aria: { label: "表示 #{task.title}" } %>
                  
                  <%= link_to "編集", task_path(task),
                      class: "btn btn-primary btn-sm",
                      aria: { label: "編集 #{task.title}" } %>
                  
                  <%= button_to "削除", task_path(task),
                      method: :delete,
                      data: { turbo_confirm: "本当に削除しますか？", confirm: "本当に削除しますか？" },
                      form: { class: "inline-delete-form" },
                      class: "btn btn-danger btn-sm" %>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <div class="filter-pagination">
        <%= paginate @tasks, params: request.query_parameters.except(:page) %>
      </div>
      <% else %>
        <ul class="task-list">
          <% @tasks.each do |task| %>
            <li class="task-item">
              <div class="task-left">
                <%= link_to task.title, task_path(task), class: "task-title" %>
                <div class="task-meta">
                  <span class="task-deadline"><%= task.deadline&.to_date %></span>
                  <span class="task-status"><%= task.status %></span>
                  <span class="task-priority"><%= task.priority %></span>
                </div>
              </div>

              <div class="task-actions">
                <%= link_to "表示", task_path(task),
                    class: "btn btn-outline btn-sm",
                    aria: { label: "表示 #{task.title}" } %>

                <%= link_to "編集", edit_task_path(task),
                    class: "btn btn-primary btn-sm",
                    aria: { label: "編集 #{task.title}" } %>

                <%= button_to "削除", task_path(task),
                    method: :delete,
                    data: { turbo_confirm: "本当に削除しますか？", confirm: "本当に削除しますか？" },
                    form: { class: "inline-delete-form" },
                    class: "btn btn-danger btn-sm" %>
              </div>
            </li>
          <% end %>
        </ul>
        <div class="filter-pagination">
         <%= paginate @tasks, params: request.query_parameters.except(:page) %>
        </div>
      <% end %>
    <% else %>
      <div class="empty-state">
        <p>まだタスクがありません。</p>
      </div>
    <% end %>
</div>