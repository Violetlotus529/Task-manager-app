<div class="index-container">
  <h1>タスク一覧</h1>
  
  <div class="search-container">
    <%= form_with url: tasks_path, method: :get, local: :true, class: "search-form" do |form| %>
      <%= form.text_field :search,
          placeholder: "タスクを検索...",
          value: params[:search],
          class: "search-input" %>
      <%= form.submit "検索", class: "btn btn-search" %>
      <% if params[:search].present? %>
        <%= link_to "クリア", tasks_path, class: "btn btn-clear" %>
      <% end %>
    <% end %>

    <% if params[:search].present? %>
      <p class="search-results">
        「<%= params[:search] %>」の検索結果: <%= @tasks.count %>件
      </p>
    <% end %>
  </div>
  <div class="filter-buttons">
    <%= link_to "全て", tasks_path({search: params[:search], page: params[:page], sort: params[:sort] }.compact), class: "btn #{'active' if params[:filter].blank?}" %>
    <%= link_to "今日", tasks_path({search: params[:search], status: params[:status], priority: params[:priority], filter: 'today' }.compact), class: "btn #{'active' if params[:filter] == 'today'}" %>
    <%= link_to "今週", tasks_path({search: params[:search], status: params[:status], priority: params[:priority], filter: 'this_week' }.compact), class: "btn #{'active' if params[:filter] == 'this_week'}" %>
    <%= link_to "期限切れ", tasks_path({search: params[:search], status: params[:status], priority: params[:priority], filter: 'overdue' }.compact), class: "btn btn-danger #{'active' if params[:filter] == 'overdue'}" %>
    <%= link_to "未着手", tasks_path({search: params[:search], priority: params[:priority], filter: params[:filter], status: 'not_started' }.compact), class: "btn btn-secondary #{'active' if params[:status] == 'not_started'}" %>
    <%= link_to "進行中", tasks_path({search: params[:search], priority: params[:priority], filter: params[:filter], status: 'in_progress'}.compact), class: "btn btn-warning #{'active' if params[:status] == 'in_progress'}" %>
    <%= link_to "完了", tasks_path({search: params[:search], priority: params[:priority], filter: params[:filter], status: 'completed'}.compact), class: "btn btn-success #{'active' if params[:status] == 'completed'}" %>
    <%= link_to "高", tasks_path({search: params[:search], status: params[:status], filter: params[:filter], page: params[:page], sort: params[:sort], priority: 'high'}.compact), class: "btn btn-danger #{'active' if params[:priority] == 'high'}" %>
    <%= link_to "中", tasks_path({search: params[:search], status: params[:status], filter: params[:filter], page: params[:page], sort: params[:sort], priority: 'medium'}.compact), class: "btn btn-warning #{'active' if params[:priority] == 'medium'}" %>
    <%= link_to "低", tasks_path({search: params[:search], status: params[:status], filter: params[:filter], page: params[:page], sort: params[:sort], priority: 'low'}.compact), class: "btn btn-secondary #{'active' if params[:priority] == 'low'}" %>
    <%= link_to "作成順", tasks_path({search: params[:search], status: params[:status], priority: params[:priority], filter: params[:filter], page: params[:page], sort: 'created_at' }.compact), class: "btn btn-secondary #{'active' if params[:sort].blank? || params[:sort] == 'created_at'}" %>
    <%= link_to "期限順", tasks_path({search: params[:search], status: params[:status], priority: params[:priority], filter: params[:filter], page: params[:page], sort: 'deadline' }.compact), class: "btn btn-warning #{'active' if params[:sort] == 'deadline'}" %>
    <%= link_to "優先度順", tasks_path({search: params[:search], status: params[:status], priority: params[:priority], filter: params[:filter], page: params[:page], sort: 'priority' }.compact), class: "btn btn-success #{'active' if params[:sort] == 'priority'}" %>
  </div>
  <div class="actions-bar">
    <%= link_to "新しいタスクを作成", "/tasks/new", class: "btn btn-primary" %>
  </div>

  <% if @tasks.any? %>
    <div class="tasks-list">
      <% @tasks.each do |task| %>
        <%
          today = Date.current
          is_overdue = task.deadline && task.deadline < today
          is_due_today = task.deadline && task.deadline == today
        %>
        <div class="task-index-item <%= 'overdue' if is_overdue %> <%= 'due-today' if is_due_today %> <%= 'completed' if task.completed? %>">
          <div class="task-title">
            <%= link_to task.title, "/tasks/#{task.id}" %>
          </div>
          <div class="task-content">
            <%= task.content %>
          </div>
          <% if task.deadline %>
            <div class="task-deadline">
              期限: <%= task.deadline.strftime('%Y年%m月%d日') %>
            </div>
          <% end %>
          <div class="task-status">
            <% case task.status %>
            <% when 'not_started' %>
              📋 未着手
            <% when 'in_progress' %>
              🔄 進行中
            <% when 'completed' %>
              ✅ 完了
            <% end %>
          </div>
          <div class="task-priority">
            <% case task.priority %>
            <% when 'high' %>
              🔴 高優先度
            <% when 'medium' %>
              🟡 中優先度
            <% when 'low' %>
              🟢 低優先度
            <% end %>
          </div>
          <div class="task-actions">
            <%= link_to "表示", "/tasks/#{task.id}", class: "btn btn-outline" %>
            <%= link_to "編集", "/tasks/#{task.id}/edit", class: "btn btn-secondary" %>
            <%= link_to case task.status
                        when 'not_started' then "進行中にする"
                        when 'in_progress' then "未完了にする"
                        when 'completed' then "未着手に戻す"
                        end,
                 toggle_status_task_path(task),
                 class: "btn #{case task.status
                               when 'not_started' then 'btn-primary'
                               when 'in_progress' then 'btn-success'
                               when 'completed' then 'btn-warning'
                               end}" %>
            <%= button_to "削除 <i class='fa-solid fa-trash'></i>".html_safe, "/tasks/#{task.id}", method: :delete, 
                onclick: "return confirm('本当に削除しますか？')", class: "btn btn-danger" %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="empty-state">
      <p>まだタスクがありません。</p>
      <%= link_to "最初のタスクを作成", "/tasks/new", class: "btn btn-primary" %>
    </div>
  <% end %>
  <%= paginate @tasks %>
</div>
